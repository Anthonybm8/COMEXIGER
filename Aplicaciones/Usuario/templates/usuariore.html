{% extends 'plantilla.html' %}
{% load static %}

{% block head %}
{{ block.super }}

<!-- ✅ DataTables CSS (Bootstrap 5) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<!-- ✅ DataTables Buttons CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<!-- ✅ SweetAlert2 CSS (si no lo tienes en plantilla) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
  table.dataTable thead th { white-space: nowrap; }
</style>
{% endblock %}

{% block body %}

<br>
<main class="container py-4">
  <h1 class="text-center">Listado de Usuarios</h1>

  <div class="text-center mb-3">
    <a href="{% url 'nuevo_usuario' %}" class="btn btn-primary">
      Nuevo Usuario
    </a>
  </div>

  <hr>

  <!-- ✅ IMPORTANTE: clases bootstrap + datatable -->
  <div class="table-responsive">
    <table id="table_usuarios" class="table table-striped table-bordered align-middle w-100">
      <thead class="table-success text-center">
        <tr>
          <th>ID</th>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Mesa</th>
          <th>Cargo</th>
          <th>Usuario</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        {% for u in usuario %}
        <tr>
          <td class="text-center">{{ u.id }}</td>
          <td>{{ u.nombres }}</td>
          <td>{{ u.apellidos }}</td>
          <td class="text-center">{{ u.mesa }}</td>
          <td>{{ u.cargo }}</td>
          <td>{{ u.username }}</td>

          <td class="text-center">
            <!-- EDITAR -->
            <button class="btn btn-outline-warning"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditar{{ u.id }}">
              <i class="fa fa-pen"></i>
            </button>

            <!-- ELIMINAR -->
            <a href="{% url 'eliminar_usuario' u.id %}"
               class="btn btn-outline-danger btn-eliminar"
               data-nombre="{{ u.nombres }} {{ u.apellidos }}"
               data-id="{{ u.id }}">
              <i class="fa fa-trash"></i>
            </a>

            <!-- MODAL EDITAR -->
            <div class="modal fade" id="modalEditar{{ u.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                    <form action="{% url 'procesar_edicion_usuario' %}"
                          method="post"
                          class="form_usuario"
                          autocomplete="off">
                      {% csrf_token %}
                      <input type="hidden" name="id" value="{{ u.id }}">

                      <label class="form-label">Nombres</label>
                      <input class="form-control" type="text" name="nombres" value="{{ u.nombres }}" required>
                      <br>

                      <label class="form-label">Apellidos</label>
                      <input class="form-control" type="text" name="apellidos" value="{{ u.apellidos }}" required>
                      <br>

                      <label class="form-label">Mesa</label>
                      <select class="form-select" name="mesa" required>
                        <option value="">-- Seleccionar mesa --</option>
                        {% for m in mesas %}
                          <option value="{{ m.nombre }}" {% if u.mesa == m.nombre %}selected{% endif %}>
                            {{ m.nombre }}
                          </option>
                        {% endfor %}
                      </select>
                      <br>

                      <label class="form-label">Cargo</label>
                      <input class="form-control" type="text" name="cargo" value="{{ u.cargo }}" required>
                      <br>

                      <label class="form-label">Usuario (username)</label>
                      <input class="form-control" type="text" name="username" value="{{ u.username }}" required>
                      <small class="text-muted">Debe ser único.</small>
                      <br><br>

                      <label class="form-label">Nueva contraseña (opcional)</label>
                      <input class="form-control" type="password" name="password"
                             placeholder="Dejar vacío para no cambiar">
                      <small class="text-muted">Si no escribes nada, se mantiene la contraseña actual.</small>
                      <br><br>

                      <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                          <i class="fa fa-times me-1"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success ms-2">
                          <i class="fa fa-save me-1"></i> Guardar Cambios
                        </button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>
            </div>
            <!-- /MODAL -->
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center">No hay usuarios registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<br><br>
{% endblock %}

{% block extra_scripts %}
<!-- ✅ jQuery (debe ir ANTES de DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- ✅ DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- ✅ Buttons (SI NO ESTO, FALLA buttons:[] ) -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- ✅ jQuery Validation -->
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>

<!-- ✅ SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(function () {

  // Validación: Solo letras
  $.validator.addMethod("lettersOnly", function(value, element) {
    return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(value);
  }, "Solo letras, por favor.");

  $('.form_usuario').each(function() {
    $(this).validate({
      ignore: [],
      rules: {
        nombres: { required: true, lettersOnly: true, minlength: 3, maxlength: 100 },
        apellidos: { required: true, lettersOnly: true, minlength: 3, maxlength: 100 },
        mesa: { required: true },
        cargo: { required: true, maxlength: 100 },
        username: { required: true, minlength: 3, maxlength: 50 },
        password: { minlength: 6 }
      },
      messages: {
        nombres: { required: "Por favor ingrese los nombres.", minlength: "Debe tener al menos 3 caracteres.", maxlength: "No puede superar 100 caracteres." },
        apellidos: { required: "Por favor ingrese los apellidos.", minlength: "Debe tener al menos 3 caracteres.", maxlength: "No puede superar 100 caracteres." },
        mesa: { required: "Por favor seleccione una mesa." },
        cargo: { required: "Por favor ingrese el cargo.", maxlength: "No puede superar 100 caracteres." },
        username: { required: "Por favor ingrese el usuario (username).", minlength: "Debe tener al menos 3 caracteres.", maxlength: "No puede superar 50 caracteres." },
        password: { minlength: "Si vas a cambiar la contraseña, debe tener al menos 6 caracteres." }
      },
      errorElement: 'div',
      errorClass: 'error',
      errorPlacement: function (error, element) { error.insertAfter(element); },
      highlight: function (element) { $(element).addClass('is-invalid'); },
      unhighlight: function (element) { $(element).removeClass('is-invalid'); },
      submitHandler: function(form) { form.submit(); }
    });
  });

  // ✅ DataTables
  const tabla = $('#table_usuarios').DataTable({
    responsive: true,
    dom: 'lBfrtip',
    buttons: [
      { extend: 'copy', text: '<i class="fa fa-copy"></i> Copiar' },
      { extend: 'csv', text: '<i class="fa fa-file-csv"></i> CSV' },
      { extend: 'excel', text: '<i class="fa fa-file-excel"></i> Excel' },
      { extend: 'pdf', text: '<i class="fa fa-file-pdf"></i> PDF' },
      { extend: 'print', text: '<i class="fa fa-print"></i> Imprimir' }
    ],
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
    },
    lengthMenu: [[5, 10, 25, 50, 100, -1],[5, 10, 25, 50, 100, "Todos"]],
    pageLength: 10
  });

  // ✅ Confirmar eliminación
  $(document).on('click', '.btn-eliminar', function(e){
    e.preventDefault();

    const url = $(this).attr('href');
    const nombre = $(this).data('nombre') || 'este usuario';

    Swal.fire({
      title: "¿Eliminar usuario?",
      html: `Vas a eliminar a <b>${nombre}</b><br><span style="color:#FFD700;">Esta acción no se puede deshacer.</span>`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar",
      background: "#000000",
      color: "#ffffff",
      confirmButtonColor: "#FFD700",
      cancelButtonColor: "#6c757d",
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) window.location.href = url;
    });
  });

});
</script>

{% endblock %}
