{% extends 'plantilla.html' %}
{% load static %}
{% block body %}

<main class="container py-4">
  <div class="row">
    <div class="col-md-3"></div>

        <div class="col-md-6 bg-black p-4 rounded-3 text-white">
        <h1 class="m-0 text-center flex-grow-1">Nuevo Registro de Usuario</h1>
        <div class="d-flex justify-content-start mb-3">
            <button type="button" class="btn btn-outline-info"
                    data-bs-toggle="modal"
                    data-bs-target="#modalMesa">
                <i class="fa fa-plus"></i> Agregar nueva mesa
            </button>
        </div>

        <form action="{% url 'guardar_usuario' %}" method="post" id="form_usuario" autocomplete="off">
            {% csrf_token %}

            <label for="nombres">Nombres</label>
            <input class="form-control" type="text" name="nombres" id="nombres" required>
            <br>

            <label for="apellidos">Apellidos</label>
            <input class="form-control" type="text" name="apellidos" id="apellidos" required>
            <br>

            <label for="mesa">Mesa</label><br>
            <select class="form-select" name="mesa" id="mesa" required>
            <option value="">-- Seleccionar mesa --</option>
            {% for m in mesas %}
                <option value="{{ m.nombre }}">{{ m.nombre }}</option>
            {% endfor %}
            </select><br>


            <label for="cargo">Cargo</label>
            <input class="form-control" type="text" name="cargo" id="cargo" required>
            <br>

            <!-- NUEVO: username -->
            <label for="username">Usuario</label>
            <input class="form-control" type="text" name="username" id="username" required>
            <small class="text-muted d-block mt-1">
            Usa letras/números y . _ - (sin espacios)
            </small>
            <br>

            <!-- NUEVO: password -->
            <label for="password">Contraseña</label>
            <input class="form-control" type="password" name="password" id="password" required>
            <br>

            <!-- Opcional pero recomendado: confirmar -->
            <label for="password2">Confirmar contraseña</label>
            <input class="form-control" type="password" name="password2" id="password2" required>
            <br>

            <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-success" type="submit">Guardar</button>
            <a class="btn btn-outline-danger" href="{% url 'usuariore' %}">Cancelar</a>
            </div>
        </form>
        </div>

    <div class="col-md-3"></div>
  </div>
</main>
<!-- ================= MODAL NUEVA MESA ================= -->
<div class="modal fade" id="modalMesa" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Agregar nueva mesa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form action="{% url 'guardar_mesa' %}" method="post">
          {% csrf_token %}

          <label class="form-label">Nombre de mesa</label>
          <input type="text" class="form-control" name="nombre"
                 placeholder="Ej: Mesa 1" required>

          <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-info ms-2">
              <i class="fa fa-save"></i> Guardar
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
<!-- =================================================== -->

<script>
$(function () {

  // Solo letras y espacios (para nombres y apellidos)
  $.validator.addMethod("lettersOnly", function(value, element) {
    return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(value);
  }, "Solo letras, por favor.");

  // Username permitido: letras/números/._- sin espacios
  $.validator.addMethod("usernameValid", function(value, element) {
    return this.optional(element) || /^[a-zA-Z0-9._-]+$/.test(value);
  }, "Usa solo letras, números y . _ - (sin espacios).");

  $('#form_usuario').validate({
    ignore: [],
    rules: {
      nombres: {
        required: true,
        lettersOnly: true,
        minlength: 3,
        maxlength: 100
      },
      apellidos: {
        required: true,
        lettersOnly: true,
        minlength: 3,
        maxlength: 100
      },
      mesa: {
        required: true,
        maxlength: 100
      },
      cargo: {
        required: true,
        maxlength: 100
      },
      username: {
        required: true,
        minlength: 3,
        maxlength: 150,
        usernameValid: true
        // Si tienes un endpoint para validar usuario disponible,
        // aquí se puede agregar "remote: '...'"
      },
      password: {
        required: true,
        minlength: 6,
        maxlength: 128
      },
      password2: {
        required: true,
        equalTo: "#password"
      }
    },
    messages: {
      nombres: {
        required: "Por favor ingrese los nombres.",
        minlength: "Debe tener al menos 3 caracteres.",
        maxlength: "No puede superar 100 caracteres.",
        lettersOnly: "Solo se permiten letras."
      },
      apellidos: {
        required: "Por favor ingrese los apellidos.",
        minlength: "Debe tener al menos 3 caracteres.",
        maxlength: "No puede superar 100 caracteres.",
        lettersOnly: "Solo se permiten letras."
      },
      mesa: {
        required: "Por favor ingrese la mesa.",
        maxlength: "No puede superar 100 caracteres."
      },
      cargo: {
        required: "Por favor ingrese el cargo.",
        maxlength: "No puede superar 100 caracteres."
      },
      username: {
        required: "Por favor ingrese un usuario.",
        minlength: "Debe tener al menos 3 caracteres.",
        maxlength: "No puede superar 150 caracteres.",
        usernameValid: "Usa solo letras, números y . _ - (sin espacios)."
      },
      password: {
        required: "Por favor ingrese una contraseña.",
        minlength: "La contraseña debe tener al menos 6 caracteres.",
        maxlength: "No puede superar 128 caracteres."
      },
      password2: {
        required: "Confirme la contraseña.",
        equalTo: "Las contraseñas no coinciden."
      }
    },
    errorElement: 'div',
    errorClass: 'error',
    errorPlacement: function (error, element) {
      error.insertAfter(element);
    },
    highlight: function (element) {
      $(element).addClass('is-invalid');
    },
    unhighlight: function (element) {
      $(element).removeClass('is-invalid');
    }
  });

});
</script>

{% endblock %}
