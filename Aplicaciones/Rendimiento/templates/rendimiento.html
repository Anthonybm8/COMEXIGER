{% extends 'plantilla.html' %}
{% load static %}
{% block body %}

<br>
<main class="container py-4"><br><br>
    <h1 class="text-center">Listado de Rendimiento</h1>
    <div class="text-center">
        <a href="{% url 'nuevo_rendimiento' %}" class="btn btn-primary">
            Nuevo Rendimiento
        </a>
    </div>
    <hr>

    <table id="table_rendimiento">
        <thead>
            <tr class="table-success">
                <th style="display:none;">Fecha ISO</th>
                <th>ID</th>
                <th>Número de Mesa</th>
                <th>Variedad</th>
                <th>Medida</th>
                <th>Bonches</th>
                <th>Fecha de Entrada</th>
                <th>Fecha de Salida</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for r in rendimiento %}
            <tr>
                <!-- COLUMNA OCULTA ISO -->
                <td style="display:none;">{{ r.fecha_entrada|date:"Y-m-d\\TH:i" }}</td>

                <td>{{ r.id }}</td>
                <td>{{ r.numero_mesa }}</td>
                <td>{{ r.variedad }}</td>
                <td>{{ r.medida }}</td>
                <td>{{ r.bonches }}</td>

                <td data-fecha="{{ r.fecha_entrada }}">{{ r.fecha_entrada }}</td>
                <td>{{ r.fecha_salida|default:"-" }}</td>

                <td>
                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditar{{ r.id }}">
                        <i class="fa fa-pen"></i>
                    </button>

                    <a href="{% url 'eliminar_rendimiento' r.id %}" class="btn btn-outline-danger"
                        onclick="return confirm('¿Seguro que deseas eliminar este rendimiento?')">
                        <i class="fa fa-trash"></i>
                    </a>

                    <!-- Modal -->
                    <div class="modal fade" id="modalEditar{{ r.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">Editar Rendimiento</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">
                                    <form action="{% url 'procesar_edicion_rendimiento' %}" method="post" class="form_rendimiento">
                                        {% csrf_token %}
                                        <input type="hidden" name="id" value="{{ r.id }}">

                                        <label>Número de Mesa</label>
                                        <input class="form-control" type="number" name="numero_mesa" value="{{ r.numero_mesa }}" required><br>

                                        <label>Variedad</label>
                                        <input class="form-control" type="text" name="variedad" value="{{ r.variedad }}" required><br>

                                        <label>Medida</label>
                                        <input class="form-control" type="text" name="medida" value="{{ r.medida }}" required><br>

                                        <label>Bonches</label>
                                        <input class="form-control" type="number" name="bonches" value="{{ r.bonches }}" required><br>

                                        <label>Fecha de Entrada</label>
                                        <input class="form-control" type="datetime-local" name="fecha_entrada"
                                               value="{{ r.fecha_entrada|date:'Y-m-d\\TH:i' }}" required><br>

                                        <label>Fecha de Salida</label>
                                        <input class="form-control" type="datetime-local" name="fecha_salida"
                                               value="{{ r.fecha_salida|date:'Y-m-d\\TH:i' }}"><br>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                                <i class="fa fa-times me-1"></i> Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-success ms-2">
                                                <i class="fa fa-save me-1"></i> Guardar Cambios
                                            </button>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- Fin Modal -->

                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center">No hay registros de rendimiento.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</main>

<script>
let table;

$(document).ready(function() {

    table = $('#table_rendimiento').DataTable({
        responsive: true,
        dom: 'lBfrtip',
        buttons: [
            { extend: 'copy', text: '<i class="fa fa-copy"></i> Copiar' },
            { extend: 'csv', text: '<i class="fa fa-file-csv"></i> CSV' },
            { extend: 'excel', text: '<i class="fa fa-file-excel"></i> Excel' },
            { extend: 'pdf', text: '<i class="fa fa-file-pdf"></i> PDF' },
            { extend: 'print', text: '<i class="fa fa-print"></i> Imprimir' }
        ],
        columnDefs: [
            { targets: 0, visible: false }   // ← CORRECTO
        ],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
        }
    });
    function formatearFechaLarga(iso) {
        if (!iso) return "-";

        const fecha = new Date(iso);
        const opciones = {
            day: "numeric",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
        };

        // Convertir a español Ecuador
        return fecha.toLocaleString("es-EC", opciones)
                    .replace(" 0", " ")           // quita cero innecesario en día/hora
                    .replace(",", "");             // elimina coma después del mes
    }

    // WEBSOCKET
    const ws = new WebSocket(
        (location.protocol === "https:" ? "wss" : "ws") + "://localhost:8000/ws/rendimientos/"
    );

    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);

        console.log("==== WS RECIBIDO ====");
        console.log("Mesa:", data.numero_mesa);
        console.log("Variedad:", data.variedad);
        console.log("Medida:", data.medida);
        console.log("Fecha entrada:", data.fecha_entrada);

        // Normalizar datos entrantes
        const incomingMesa  = parseInt(data.numero_mesa);
        const incomingVar   = (data.variedad || "").toLowerCase().trim();
        const incomingMed   = (data.medida || "").toLowerCase().trim();
        const incomingFecha = (data.fecha_entrada || "").split("T")[0];

        console.log("Fecha ISO procesada:", incomingFecha);

        let filaExistente = null;

        console.log("=== BUSCANDO FILA COINCIDENTE ===");

        table.rows().every(function() {
            const row = this.data();

            // OJO: índices basados en tu tabla
            const rowFechaISO = ("" + row[0]).split("T")[0]; 
            const rowMesa = parseInt(row[2]);
            const rowVar  = (row[3] || "").toLowerCase().trim();
            const rowMed  = (row[4] || "").toLowerCase().trim();


            console.log("------------------------------");
            console.log("Revisando fila:");
            console.log("Fila Mesa:", rowMesa, " | Incoming:", incomingMesa);
            console.log("Fila Var:",  rowVar,  " | Incoming:", incomingVar);
            console.log("Fila Med:",  rowMed,  " | Incoming:", incomingMed);
            console.log("Fila Fecha:", rowFechaISO, " | Incoming:", incomingFecha);

            const cmpMesa  = (rowMesa === incomingMesa);
            const cmpVar   = (rowVar === incomingVar);
            const cmpMed   = (rowMed === incomingMed);
            const cmpFecha = (rowFechaISO === incomingFecha);

            console.log("Coincidencias => Mesa:", cmpMesa, " Var:", cmpVar, " Med:", cmpMed, " Fecha:", cmpFecha);

            if (cmpMesa && cmpVar && cmpMed && cmpFecha) {
                console.log(">>> FILA COINCIDENTE ENCONTRADA");
                filaExistente = this;
                return false;
            }
        });

        // SI EXISTE → ACTUALIZAR BONCHES
        if (filaExistente) {
            const rowData = filaExistente.data();
            const bonchesActuales = parseInt(rowData[5]) || 0;

            console.log("Actualizando bonches:");
            console.log("Bonches actuales:", bonchesActuales);
            console.log("Bonches entrantes:", data.bonches);

            // Aquí decides si SUMA 1 o SUMA lo que diga el WS
            rowData[5] = bonchesActuales + 1;

            filaExistente.data(rowData).draw(false);
            console.log(">>> FILA ACTUALIZADA");
            return;
        }

        console.log(">>> NO SE ENCONTRÓ FILA COINCIDENTE — CREANDO NUEVA");

        // SI NO EXISTE → CREAR FILA NUEVA
        table.row.add([
            data.fecha_entrada,             // 0 Fecha ISO (oculta)
            data.id,                        // 1 ID
            data.numero_mesa,               // 2 Mesa
            data.variedad,                  // 3 Variedad
            data.medida,                    // 4 Medida
            data.bonches,                   // 5 Bonches
            formatearFechaLarga(data.fecha_entrada),             // 6 Fecha entrada
            data.fecha_salida || "-",       // 7 Fecha salida
            `<button class="btn btn-outline-warning"><i class="fa fa-pen"></i></button>
            <a href="/rendimiento/eliminar/${data.id}/" class="btn btn-outline-danger">
            <i class="fa fa-trash"></i></a>` // 8 Acciones
        ]).draw(false);


        console.log(">>> FILA NUEVA AGREGADA");
    };


});
</script>

<br><br>
{% endblock %}
