{% extends 'plantilla.html' %}
{% load static %}
{% block body %}

<br>
<main class="container py-4"><br><br>
    <h1 class="text-center">Listado de Rendimiento</h1>
    <hr>

    <!-- FILTROS Y ORDENAMIENTOS -->
    <div class="card p-3 mb-4">
        <div class="row g-3">

            <!-- Ordenar por -->
            <div class="col-md-3">
                <label class="form-label fw-bold">Ordenar por</label>
                <select id="ordenarPor" class="form-select">
                    <option value="">-- Seleccionar --</option>
                    <option value="mesa">Mesa</option>
                    <option value="fecha">Fecha</option>
                </select>
            </div>

            <!-- Más recientes / más antiguos -->
            <div class="col-md-3">
                <label class="form-label fw-bold">Mostrar</label>
                <select id="ordenReciente" class="form-select">
                    <option value="">-- Seleccionar --</option>
                    <option value="true">Más recientes primero</option>
                    <option value="false">Más antiguos primero</option>
                </select>
            </div>

            <!-- Fecha exacta -->
            <div class="col-md-3">
                <label class="form-label fw-bold">Fecha exacta</label>
                <input type="date" id="fechaExacta" class="form-control">
            </div>

            <!-- Rango desde -->
            <div class="col-md-3">
                <label class="form-label fw-bold">Desde</label>
                <input type="date" id="fechaDesde" class="form-control">
            </div>

            <!-- Rango hasta -->
            <div class="col-md-3 mt-3">
                <label class="form-label fw-bold">Hasta</label>
                <input type="date" id="fechaHasta" class="form-control">
            </div>

            <!-- Botón aplicar -->
            <div class="col-md-3 mt-4">
                <button id="btnAplicarFiltros" class="btn btn-primary w-100">
                    <i class="fa fa-filter"></i> Aplicar filtros
                </button>
            </div>

            <!-- Botón limpiar -->
            <div class="col-md-3 mt-4">
                <button id="btnLimpiarFiltros" class="btn btn-secondary w-100">
                    <i class="fa fa-eraser"></i> Limpiar
                </button>
            </div>

        </div>
    </div>

    <table id="table_rendimiento">
        <thead>
            <tr class="table-success">
                <!-- ✅ GUARDAMOS SOLO LA FECHA (YYYY-MM-DD) PARA QUE NUNCA SE "SEPARA" AL RECARGAR -->
                <th style="display:none;">Fecha Key</th>

                <th>ID</th>
                <th>Mesa</th>
                <th>Fecha</th>
                <th>Rendimiento</th>
                <th>Inicio</th>
                <th>Final</th>
                <th>Horas</th>
                <th>Base</th>
                <th>Esperados</th>
                <th>Reales</th>
                <th>Extras</th>
                <th>Ext/Hora</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for r in rendimiento %}
            <tr>
                <!-- ✅ SOLO FECHA, NO datetime -->
                <td style="display:none;">{{ r.fecha_entrada|date:"Y-m-d" }}</td>

                <td>{{ r.id }}</td>
                <td>{{ r.numero_mesa }}</td>

                <!-- ✅ FECHA BONITA (pero la key real está en la columna oculta) -->
                <td>{{ r.fecha_entrada|date:"d \\d\\e F \\d\\e Y H:i" }}</td>

                <!-- ✅ rendimiento base 20 si viene null -->
                <td>{% if r.rendimiento %}{{ r.rendimiento }}{% else %}20{% endif %}</td>

                <td>{{ r.hora_inicio|default:"-" }}</td>
                <td>{{ r.hora_final|default:"-" }}</td>
                <td>{{ r.horas_trabajadas|default:"-" }}</td>
                <td>{{ r.ramos_base|default:"-" }}</td>
                <td>{{ r.ramos_esperados|default:"-" }}</td>
                <td>{{ r.bonches|default:"0" }}</td>
                <td>{{ r.ramos_extras|default:"-" }}</td>
                <td>{{ r.extras_por_hora|default:"-" }}</td>

                <td>
                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditar{{ r.id }}">
                        <i class="fa fa-pen"></i>
                    </button>
                    <a href="{% url 'eliminar_rendimiento' r.id %}" class="btn btn-outline-danger"
                       onclick="return confirm('¿Seguro que deseas eliminar este rendimiento?')">
                        <i class="fa fa-trash"></i>
                    </a>

                    <div class="modal fade" id="modalEditar{{ r.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">Editar Rendimiento</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">
                                    <form action="{% url 'procesar_edicion_rendimiento' %}" method="post" class="form_rendimiento">
                                        {% csrf_token %}
                                        <input type="hidden" name="id" value="{{ r.id }}">

                                        <label>Número de Mesa</label>
                                        <input class="form-control" type="number" name="numero_mesa" value="{{ r.numero_mesa }}" required><br>

                                        <label>Rendimiento</label>
                                        <input class="form-control" type="text" name="rendimiento" value="{% if r.rendimiento %}{{ r.rendimiento }}{% else %}20{% endif %}" required><br>

                                        <label>Inicio</label>
                                        <input class="form-control" type="text" name="hora_inicio" value="{{ r.hora_inicio }}"><br>

                                        <label>Final</label>
                                        <input class="form-control" type="text" name="hora_final" value="{{ r.hora_final }}"><br>

                                        <label>Horas</label>
                                        <input class="form-control" type="text" name="horas_trabajadas" value="{{ r.horas_trabajadas }}"><br>

                                        <label>Base</label>
                                        <input class="form-control" type="text" name="ramos_base" value="{{ r.ramos_base }}"><br>

                                        <label>Esperados</label>
                                        <input class="form-control" type="text" name="ramos_esperados" value="{{ r.ramos_esperados }}"><br>

                                        <label>Reales (Bonches)</label>
                                        <input class="form-control" type="number" name="bonches" value="{{ r.bonches }}"><br>

                                        <label>Extras</label>
                                        <input class="form-control" type="text" name="ramos_extras" value="{{ r.ramos_extras }}"><br>

                                        <label>Ext/Hora</label>
                                        <input class="form-control" type="text" name="extras_por_hora" value="{{ r.extras_por_hora }}"><br>

                                        <label>Fecha de Entrada</label>
                                        <input class="form-control" type="datetime-local" name="fecha_entrada"
                                               value="{{ r.fecha_entrada|date:'Y-m-d\\TH:i' }}" required><br>

                                        <label>Fecha de Salida</label>
                                        <input class="form-control" type="datetime-local" name="fecha_salida"
                                               value="{{ r.fecha_salida|date:'Y-m-d\\TH:i' }}"><br>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                                <i class="fa fa-times me-1"></i> Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-success ms-2">
                                                <i class="fa fa-save me-1"></i> Guardar Cambios
                                            </button>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>

                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</main>

<script>
/**
 * ✅ IMPORTANTE:
 * - Para comparar y evitar duplicados, usamos SOLO "YYYY-MM-DD"
 * - La hora NO importa para la lógica de "fila existente"
 */

// Devuelve "YYYY-MM-DD" desde ISO o Date
function toDateKey(value) {
    if (!value) return "";
    const d = new Date(value);
    if (isNaN(d.getTime())) return String(value).slice(0, 10); // fallback
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
}

function formatearFechaLarga(iso) {
    if (!iso) return "-";
    const fecha = new Date(iso);
    const opciones = { day: "numeric", month: "long", year: "numeric", hour: "2-digit", minute: "2-digit" };
    return fecha.toLocaleString("es-EC", opciones).replace(" 0", " ").replace(",", "");
}

let table;

$(document).ready(function() {
    table = $('#table_rendimiento').DataTable({
        order: [],
        ordering: false,
        responsive: true,
        dom: 'lBfrtip',
        buttons: [
            { extend: 'copy', text: '<i class="fa fa-copy"></i> Copiar' },
            { extend: 'csv', text: '<i class="fa fa-file-csv"></i> CSV' },
            { extend: 'excel', text: '<i class="fa fa-file-excel"></i> Excel' },
            { extend: 'pdf', text: '<i class="fa fa-file-pdf"></i> PDF' },
            { extend: 'print', text: '<i class="fa fa-print"></i> Imprimir' }
        ],
        columnDefs: [{ targets: 0, visible: false }],
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' }
    });

    // =======================
    // WEBSOCKET
    // =======================
    // ✅ usa host actual (evita problemas cuando no es localhost)
    const ws = new WebSocket(
        (location.protocol === "https:" ? "wss" : "ws") +
        "://" + window.location.host + "/ws/rendimientos/"
    );

    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);

        const incomingMesa = parseInt(data.numero_mesa);
        const incomingKey  = toDateKey(data.fecha_entrada); // ✅ SOLO FECHA

        let filaExistente = null;

        table.rows().every(function() {
            const row = this.data();

            // row[0] = Fecha Key oculta (YYYY-MM-DD)
            const rowKey  = String(row[0] || "");
            const rowMesa = parseInt(row[2]);

            if (rowMesa === incomingMesa && rowKey === incomingKey) {
                filaExistente = this;
                return false;
            }
        });

        // ✅ Si existe: SUMAR Reales (bonches)
        if (filaExistente) {
            const rowData = filaExistente.data();
            const actuales = parseInt(rowData[10]) || 0;
            rowData[10] = actuales + 1;
            filaExistente.data(rowData).draw(false);
            return;
        }

        // ✅ Si NO existe: crear fila
        const rendimientoBase = (data.rendimiento !== null && data.rendimiento !== undefined && data.rendimiento !== "")
            ? data.rendimiento
            : 20;

        table.row.add([
            incomingKey,                           // 0 Fecha Key (YYYY-MM-DD) ✅ CLAVE ESTABLE
            data.id,                               // 1 ID
            data.numero_mesa,                      // 2 Mesa
            formatearFechaLarga(data.fecha_entrada), // 3 Fecha bonita
            rendimientoBase,                       // 4 Rendimiento (base 20)
            data.hora_inicio || "-",               // 5 Inicio
            data.hora_final || "-",                // 6 Final
            data.horas_trabajadas || "-",          // 7 Horas
            data.ramos_base || "-",                // 8 Base
            data.ramos_esperados || "-",           // 9 Esperados
            data.bonches || 1,                     // 10 Reales
            data.ramos_extras || "-",              // 11 Extras
            data.extras_por_hora || "-",           // 12 Ext/Hora
            `<button class="btn btn-outline-warning"><i class="fa fa-pen"></i></button>
             <a href="/rendimiento/eliminar/${data.id}/" class="btn btn-outline-danger">
             <i class="fa fa-trash"></i></a>`      // 13 Acciones
        ]).draw(false);
    };
});

// =======================
// FILTROS Y ORDENAMIENTO (mismo patrón que disponibilidad)
// =======================
document.getElementById("btnAplicarFiltros").addEventListener("click", function () {
    let ordenar = document.getElementById("ordenarPor").value;
    let reciente = document.getElementById("ordenReciente").value;
    let fecha = document.getElementById("fechaExacta").value;
    let desde = document.getElementById("fechaDesde").value;
    let hasta = document.getElementById("fechaHasta").value;

    let url = "/api/rendimientos/?";

    if (ordenar) url += `ordenar=${ordenar}&`;
    if (reciente) url += `reciente=${reciente}&`;
    if (fecha) url += `fecha=${fecha}&`;
    if (desde && hasta) url += `desde=${desde}&hasta=${hasta}&`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            table.clear();
            data.forEach(item => {
                const key = toDateKey(item.fecha_entrada);
                const rendBase = (item.rendimiento !== null && item.rendimiento !== undefined && item.rendimiento !== "")
                    ? item.rendimiento
                    : 20;

                table.row.add([
                    key,
                    item.id,
                    item.numero_mesa,
                    formatearFechaLarga(item.fecha_entrada),
                    rendBase,
                    item.hora_inicio || "-",
                    item.hora_final || "-",
                    item.horas_trabajadas || "-",
                    item.ramos_base || "-",
                    item.ramos_esperados || "-",
                    item.bonches || 0,
                    item.ramos_extras || "-",
                    item.extras_por_hora || "-",
                    `<button class="btn btn-outline-warning"><i class="fa fa-pen"></i></button>
                     <a href="/rendimiento/eliminar/${item.id}/" class="btn btn-outline-danger">
                     <i class="fa fa-trash"></i></a>`
                ]);
            });
            table.draw(false);
        });
});

document.getElementById("btnLimpiarFiltros").addEventListener("click", function () {
    document.getElementById("ordenarPor").value = "";
    document.getElementById("ordenReciente").value = "";
    document.getElementById("fechaExacta").value = "";
    document.getElementById("fechaDesde").value = "";
    document.getElementById("fechaHasta").value = "";

    fetch("/api/rendimientos/")
        .then(r => r.json())
        .then(data => {
            table.clear();
            data.forEach(item => {
                const key = toDateKey(item.fecha_entrada);
                const rendBase = (item.rendimiento !== null && item.rendimiento !== undefined && item.rendimiento !== "")
                    ? item.rendimiento
                    : 20;

                table.row.add([
                    key,
                    item.id,
                    item.numero_mesa,
                    formatearFechaLarga(item.fecha_entrada),
                    rendBase,
                    item.hora_inicio || "-",
                    item.hora_final || "-",
                    item.horas_trabajadas || "-",
                    item.ramos_base || "-",
                    item.ramos_esperados || "-",
                    item.bonches || 0,
                    item.ramos_extras || "-",
                    item.extras_por_hora || "-",
                    `<button class="btn btn-outline-warning"><i class="fa fa-pen"></i></button>
                     <a href="/rendimiento/eliminar/${item.id}/" class="btn btn-outline-danger">
                     <i class="fa fa-trash"></i></a>`
                ]);
            });
            table.draw(false);
        });
});
</script>

<br><br>
{% endblock %}
