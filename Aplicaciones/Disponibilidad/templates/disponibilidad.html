{% extends 'plantilla.html' %}
{% load static %}
{% block body %}

<br>
<main class="container py-4"><br><br>
    <h1 class="text-center">Listado de Disponibilidad</h1>
    <hr>

    <!-- TABLA MATRIZ -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span class="fw-bold"><i class="fa fa-table"></i> Disponibilidad por Variedad y Medida</span>

            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregarVariedad">
                    <i class="fa fa-plus"></i> Agregar variedad
                </button>

                <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalSubirExcel">
                    <i class="fa fa-file-excel"></i> Subir Excel
                </button>
            </div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table id="tabla_matriz" class="table table-bordered table-hover align-middle text-center mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th rowspan="2" class="text-start">Variedades</th>
                            <th colspan="5">Medidas</th>
                        </tr>
                        <tr>
                            <th>40 cm</th>
                            <th>50 cm</th>
                            <th>60 cm</th>
                            <th>70 cm</th>
                            <th>80 cm</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_matriz">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>

            <div class="mt-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <small class="text-muted">
                    Clic en una celda para editar. La disponibilidad se actualiza en tiempo real.
                </small>
                <button class="btn btn-outline-secondary btn-sm" id="btnRefrescar">
                    <i class="fa fa-rotate"></i> Refrescar
                </button>
            </div>
        </div>
    </div>
</main>

<!-- MODAL EDITAR CELDA -->
<div class="modal fade" id="modalEditarCelda" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold"><i class="fa fa-pen"></i> Editar Disponibilidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-info py-2">
                    <small>
                        Editando: <span class="fw-bold" id="editInfoVar"></span> |
                        <span class="fw-bold" id="editInfoMed"></span>
                    </small>
                </div>

                <form id="formEditarCelda" action="{% url 'procesar_edicion_disponibilidad' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="id" id="edit_id">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="fw-bold">Variedad</label>
                            <input class="form-control" type="text" name="variedad" id="edit_variedad" required>
                        </div>

                        <div class="col-md-6">
                            <label class="fw-bold">Medida</label>
                            <input class="form-control" type="text" name="medida" id="edit_medida" required>
                            <small class="text-muted">Ej: 40 cm, 50 cm…</small>
                        </div>

                        <div class="col-md-6">
                            <label class="fw-bold">Stock</label>
                            <input class="form-control" type="number" name="stock" id="edit_stock" required min="0">
                        </div>

                        <div class="col-md-6">
                            <label class="fw-bold">Mesa</label>
                            <input class="form-control" type="number" name="numero_mesa" id="edit_mesa" required>
                        </div>

                        <div class="col-md-6">
                            <label class="fw-bold">Fecha Entrada</label>
                            <input class="form-control" type="datetime-local" name="fecha_entrada" id="edit_fecha_entrada" required>
                        </div>

                        <div class="col-md-6">
                            <label class="fw-bold">Fecha Salida</label>
                            <input class="form-control" type="datetime-local" name="fecha_salida" id="edit_fecha_salida">
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success px-4">
                            <i class="fa fa-save"></i> Guardar cambios
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- MODAL AGREGAR VARIEDAD -->
<div class="modal fade" id="modalAgregarVariedad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fa fa-plus"></i> Agregar variedad</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label class="fw-bold">Nombre de la variedad</label>
                <input type="text" id="inputNuevaVariedad" class="form-control"
                       placeholder="Ej: Blanca, Roja, Explorer..." autocomplete="off">
                <small class="text-muted">Se agregará como fila en la matriz.</small>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnGuardarVariedad">
                    <i class="fa fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL SUBIR EXCEL -->
<div class="modal fade" id="modalSubirExcel" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="fa fa-file-excel"></i> Subir Excel de variedades</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-info">
                    <b>Formato del Excel:</b>
                    <ul class="mb-0">
                        <li>Una columna llamada <b>variedad</b> (recomendado)</li>
                        <li>O la primera columna con nombres de variedades</li>
                    </ul>
                </div>

                <input type="file" id="inputExcelVariedades" class="form-control" accept=".xlsx,.xls">

                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-success" id="btnSubirExcelBD">
                        <i class="fa fa-upload"></i> Subir a BD
                    </button>
                </div>

                <div class="mt-3 small text-muted" id="excelResultado"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    #tabla_matriz th { vertical-align: middle; }
    #tabla_matriz td { min-width: 90px; font-weight: 650; cursor: pointer; }
    #tabla_matriz tbody tr:hover td { background: #f6fff8; }

    .cell-wrap { display: flex; justify-content: center; gap: 8px; align-items: center; }
    .cell-stock {
        border-radius: 12px;
        padding: 6px 12px;
        display: inline-block;
        min-width: 48px;
    }
    .stock-0 { background: #f8d7da; color: #842029; }
    .stock-low { background: #fff3cd; color: #664d03; }
    .stock-ok { background: #d1e7dd; color: #0f5132; }

    .cell-edit {
        border: 1px solid rgba(0,0,0,.12);
        border-radius: 10px;
        padding: 6px 8px;
        background: #fff;
    }
    .cell-edit i { font-size: 14px; opacity: .7; }

    .modal-content { border-radius: 18px; }
    .modal-header { border-top-left-radius: 18px; border-top-right-radius: 18px; }
</style>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function isoToDatetimeLocal(iso) {
  if (!iso) return "";
  return ("" + iso).slice(0, 16);
}

function cerrarModalSeguro(modalId) {
  const el = document.getElementById(modalId);
  if (!el) return;
  const modal = bootstrap.Modal.getOrCreateInstance(el);
  modal.hide();
  setTimeout(() => {
    document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());
    document.body.classList.remove("modal-open");
    document.body.style.removeProperty("padding-right");
  }, 200);
}

const MEDIDAS = ["40", "50", "60", "70", "80"];
let matriz = {};
let VAR_MAP = {};

function normalizarTexto(t) {
  return (t || "").toString().trim().toLowerCase();
}
function normalizarMedida(m) {
  const x = (m || "").toString().toLowerCase().replace(/\s/g, "");
  return x.replace("cm", "");
}
function claseStock(valor) {
  const v = parseInt(valor || 0);
  if (v <= 0) return "stock-0";
  if (v <= 2) return "stock-low";
  return "stock-ok";
}

function agregarFilaVariedadSiNoExiste(nombreVariedad, variedadId="") {
  const vKey = normalizarTexto(nombreVariedad);
  if (!vKey) return;

  VAR_MAP[vKey] = { id: variedadId || (VAR_MAP[vKey]?.id || ""), nombre: nombreVariedad };

  let fila = document.querySelector(`#tbody_matriz tr[data-var="${vKey}"]`);
  if (fila) {
    if (variedadId) fila.dataset.variedadId = variedadId;
    return;
  }

  fila = document.createElement("tr");
  fila.setAttribute("data-var", vKey);
  fila.dataset.variedadId = variedadId || "";

  const tdNombre = document.createElement("td");
  tdNombre.className = "text-start fw-bold d-flex justify-content-between align-items-center gap-2";
  tdNombre.innerHTML = `
    <span class="var-name">${nombreVariedad}</span>
    <button class="btn btn-sm btn-outline-danger btnEliminarVariedad" title="Eliminar variedad">
      <i class="fa fa-trash"></i>
    </button>
  `;
  fila.appendChild(tdNombre);

  MEDIDAS.forEach(mm => {
    const td = document.createElement("td");
    td.setAttribute("data-med", mm);
    td.dataset.id = "";
    td.dataset.variedad = nombreVariedad;
    td.dataset.medida = `${mm} cm`;
    td.dataset.stock = 0;

    td.innerHTML = `
      <div class="cell-wrap">
        <span class="cell-stock ${claseStock(0)}">0</span>
        <span class="cell-edit" title="Editar"><i class="fa fa-pen"></i></span>
      </div>
    `;
    fila.appendChild(td);
  });

  document.getElementById("tbody_matriz").appendChild(fila);
}

function cargarVariedadesBD() {
  return fetch("/api/variedades/", { credentials: "same-origin" })
    .then(r => r.json())
    .then(lista => {
      lista.forEach(v => agregarFilaVariedadSiNoExiste(v.nombre, v.id));
    });
}

function resetearTablaACero() {
  document.querySelectorAll("#tbody_matriz tr").forEach(tr => {
    const nombre = tr.querySelector(".var-name")?.textContent?.trim() || "";
    const vKey = normalizarTexto(nombre);

    MEDIDAS.forEach(mm => {
      const td = tr.querySelector(`td[data-med="${mm}"]`);
      if (!td) return;

      td.dataset.id = "";
      td.dataset.mesa = "";
      td.dataset.variedad = nombre;
      td.dataset.medida = `${mm} cm`;
      td.dataset.stock = 0;
      td.dataset.fecha_entrada = "";
      td.dataset.fecha_salida = "";

      td.innerHTML = `
        <div class="cell-wrap">
          <span class="cell-stock ${claseStock(0)}">0</span>
          <span class="cell-edit" title="Editar"><i class="fa fa-pen"></i></span>
        </div>
      `;

      if (!matriz[vKey]) matriz[vKey] = {};
      if (!matriz[vKey][mm]) matriz[vKey][mm] = { total: 0, refItem: null };
    });
  });
}

function setCelda(variedadOriginal, medidaOriginal, total, refItem) {
  const vKey = normalizarTexto(variedadOriginal);
  const mKey = normalizarMedida(medidaOriginal);
  if (!MEDIDAS.includes(mKey)) return;

  if (!matriz[vKey]) matriz[vKey] = {};
  if (!matriz[vKey][mKey]) matriz[vKey][mKey] = { total: 0, refItem: null };
  matriz[vKey][mKey].total = parseInt(total || 0);

  agregarFilaVariedadSiNoExiste(VAR_MAP[vKey]?.nombre || variedadOriginal, VAR_MAP[vKey]?.id || "");

  const fila = document.querySelector(`#tbody_matriz tr[data-var="${vKey}"]`);
  if (!fila) return;

  const celda = fila.querySelector(`td[data-med="${mKey}"]`);
  if (!celda) return;

  const val = matriz[vKey][mKey].total || 0;
  celda.innerHTML = `
    <div class="cell-wrap">
      <span class="cell-stock ${claseStock(val)}">${val}</span>
      <span class="cell-edit" title="Editar"><i class="fa fa-pen"></i></span>
    </div>
  `;

  celda.dataset.stock = val;
  celda.dataset.variedad = VAR_MAP[vKey]?.nombre || variedadOriginal;
  celda.dataset.medida = `${mKey} cm`;
}

function construirMatrizDesdeAPI(data) {
  matriz = {};
  data.forEach(item => {
    if (!item.variedad) return;
    agregarFilaVariedadSiNoExiste(item.variedad, "");
  });

  resetearTablaACero();

  data.forEach(item => {
    const vKey = normalizarTexto(item.variedad);
    const mKey = normalizarMedida(item.medida);
    if (!vKey || !MEDIDAS.includes(mKey)) return;

    if (!matriz[vKey]) matriz[vKey] = {};
    if (!matriz[vKey][mKey]) matriz[vKey][mKey] = { total: 0, refItem: null };

    matriz[vKey][mKey].total += parseInt(item.stock || 0);
  });

  Object.keys(matriz).forEach(vKey => {
    const nombre = VAR_MAP[vKey]?.nombre || vKey;
    MEDIDAS.forEach(mm => {
      const cel = matriz[vKey][mm];
      const val = cel ? cel.total : 0;
      setCelda(nombre, `${mm} cm`, val, null);
    });
  });
}

function cargarMatriz(url="/api/disponibilidades/") {
  return fetch(url, { credentials: "same-origin" })
    .then(r => r.json())
    .then(data => construirMatrizDesdeAPI(data))
    .catch(err => console.error("❌ Error carga matriz disponibilidad:", err));
}

function abrirModalEdicionDesdeCelda(td) {
  const variedad = td.dataset.variedad || "";
  const medida = td.dataset.medida || "";
  const stock = td.dataset.stock || 0;

  document.getElementById("editInfoVar").textContent = variedad || "—";
  document.getElementById("editInfoMed").textContent = medida || "—";

  document.getElementById("edit_variedad").value = variedad;
  document.getElementById("edit_medida").value = medida;
  document.getElementById("edit_stock").value = stock;

  const now = new Date();
  const localISO = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0,16);
  document.getElementById("edit_fecha_entrada").value = localISO;

  const modal = new bootstrap.Modal(document.getElementById("modalEditarCelda"));
  modal.show();
}

document.addEventListener("DOMContentLoaded", () => {

  cargarVariedadesBD().then(() => cargarMatriz());

  document.getElementById("btnRefrescar").addEventListener("click", () => {
    cargarVariedadesBD().then(() => cargarMatriz());
  });

  document.addEventListener("click", function(e) {
    const td = e.target.closest("#tabla_matriz tbody td[data-med]");
    if (!td) return;
    abrirModalEdicionDesdeCelda(td);
  });

  // agregar variedad
  document.getElementById("btnGuardarVariedad").addEventListener("click", async () => {
    const input = document.getElementById("inputNuevaVariedad");
    const nombre = (input.value || "").trim();

    if (!nombre) {
      Swal.fire({ title:"Advertencia", text:"Escribe el nombre de la variedad.", icon:"warning" });
      return;
    }

    const resp = await fetch("/api/variedades/", {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ nombre })
    });

    const data = await resp.json().catch(() => ({}));

    if (!resp.ok) {
      Swal.fire({ title:"Error", text: data.detail || "No se pudo guardar la variedad.", icon:"error" });
      return;
    }

    agregarFilaVariedadSiNoExiste(data.nombre || nombre, data.id || "");
    input.value = "";
    cerrarModalSeguro("modalAgregarVariedad");
    Swal.fire({ title:"Éxito", text:"Variedad agregada correctamente.", icon:"success" });
  });

  // subir excel
  document.getElementById("btnSubirExcelBD").addEventListener("click", () => {
    const f = document.getElementById("inputExcelVariedades").files[0];
    if (!f) return Swal.fire("Advertencia","Selecciona un archivo Excel.","warning");

    const fd = new FormData();
    fd.append("file", f);

    const out = document.getElementById("excelResultado");
    out.textContent = "⏳ Subiendo Excel...";

    fetch("/api/variedades/excel/", {
      method: "POST",
      credentials: "same-origin",
      headers: { "X-CSRFToken": getCookie("csrftoken") },
      body: fd
    })
    .then(r => r.json())
    .then(resp => {
      out.innerHTML = `✅ Listo. Creadas: <b>${resp.creadas}</b> | Existentes: <b>${resp.existentes}</b> | Total: <b>${resp.total}</b>`;
      return cargarVariedadesBD().then(() => cargarMatriz());
    })
    .catch(() => out.textContent = "❌ Error subiendo el Excel.");
  });

  // ✅ eliminar variedad (ahora maneja 404 / 409 / 204)
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".btnEliminarVariedad");
    if (!btn) return;

    const fila = btn.closest("tr");
    const variedadId = fila?.dataset?.variedadId;
    const nombre = fila.querySelector(".var-name")?.textContent?.trim() || "—";

    if (!variedadId) {
      Swal.fire("Error", "No se encontró el ID de la variedad.", "error");
      return;
    }

    const confirm = await Swal.fire({
      title: "¿Eliminar variedad?",
      text: `Se eliminará la variedad: ${nombre}`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#dc3545",
    });

    if (!confirm.isConfirmed) return;

    try {
      const resp = await fetch(`/api/variedades/${variedadId}/`, {
        method: "DELETE",
        credentials: "same-origin",
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      });

      if (resp.status === 204) {
        fila.remove();
        Swal.fire("Eliminado", "La variedad fue eliminada.", "success");
        return;
      }

      if (resp.status === 404) {
        fila.remove();
        Swal.fire("Aviso", "La variedad no existe o ya fue eliminada.", "info");
        return;
      }

      if (resp.status === 409) {
        const data = await resp.json().catch(() => ({}));
        Swal.fire("No se pudo eliminar", data.detail || "No puedes borrar esta variedad porque tiene stock/movimientos.", "error");
        return;
      }

      const data = await resp.json().catch(() => ({}));
      Swal.fire("Error", data.detail || "No se pudo eliminar la variedad.", "error");

    } catch (err) {
      console.error(err);
      Swal.fire("Error", "Error de red al eliminar.", "error");
    }
  });

  // websocket
  const ws = new WebSocket(
    (location.protocol === "https:" ? "wss" : "ws") +
    "://" + window.location.host + "/ws/disponibilidad/"
  );

  ws.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.variedad && data.medida) {
      setCelda(data.variedad, data.medida, data.stock || 0, data);
    }
  };

});
</script>

{% endblock %}
